# Sing-Box Windows Документация по разработке

## Содержание

- [Обзор проекта](#обзор-проекта)
- [Технологический стек](#технологический-стек)
- [Структура проекта](#структура-проекта)
- [Настройка среды разработки](#настройка-среды-разработки)
- [Основные функциональные модули](#основные-функциональные-модули)
- [Руководство по разработке фронтенда](#руководство-по-разработке-фронтенда)
- [Руководство по разработке бэкенда](#руководство-по-разработке-бэкенда)
- [Сборка и выпуск](#сборка-и-выпуск)
- [Часто задаваемые вопросы](#часто-задаваемые-вопросы)

## Обзор проекта

Sing-Box Windows - это клиент с графическим интерфейсом для Windows, основанный на прокси-ядре [Sing-Box](https://github.com/SagerNet/sing-box), разработанный с использованием фреймворка Tauri 2.0. Цель проекта - предоставить элегантный, эффективный и удобный интерфейс для управления прокси.

Основные особенности проекта:

- Современный пользовательский интерфейс с поддержкой светлой и темной тем
- Различные режимы прокси (системный прокси/TUN режим)
- Поддержка различных форматов подписок
- Мониторинг и статистика трафика в реальном времени
- Богатая система логирования
- Функция разделения по правилам

## Технологический стек

### Фронтенд технологии

- **Vue 3**: основной фронтенд фреймворк
- **TypeScript**: типобезопасный JavaScript
- **Naive UI**: высококачественная библиотека компонентов для Vue 3
- **Pinia**: библиотека управления состоянием для Vue
- **Vue Router**: управление маршрутизацией в Vue
- **VueUse**: набор утилит для Vue

### Бэкенд технологии

- **Rust**: высокопроизводительный системный язык программирования
- **Tauri 2.0**: фреймворк для создания кроссплатформенных приложений
- **tokio**: асинхронное выполнение
- **serde**: сериализация и десериализация
- **reqwest**: HTTP клиент

## Структура проекта

```
sing-box-windows/
├── src/                # Исходный код фронтенда
│   ├── assets/        # Статические ресурсы
│   ├── components/    # Общие компоненты
│   │   └── layout/    # Компоненты макета
│   ├── router/        # Конфигурация маршрутизации
│   ├── stores/        # Управление состоянием
│   ├── utils/         # Вспомогательные функции
│   │   ├── format.ts  # Утилиты форматирования
│   │   └── mitt.ts    # Шина событий
│   ├── views/         # Компоненты страниц
│   │   ├── HomeView.vue      # Главная страница
│   │   ├── ProxyView.vue     # Управление прокси
│   │   ├── SubView.vue       # Управление подписками
│   │   ├── LogView.vue       # Просмотр логов
│   │   ├── SettingView.vue   # Страница настроек
│   │   ├── RulesView.vue     # Управление правилами
│   │   └── ConnectionsView.vue # Управление соединениями
│   └── App.vue         # Корневой компонент
├── src-tauri/         # Исходный код бэкенда на Rust
│   ├── src/           # Исходный код
│   │   ├── app/       # Сервисы приложения
│   │   │   ├── kernel_service.rs    # Сервис ядра
│   │   │   ├── proxy_service.rs     # Сервис прокси
│   │   │   ├── subscription_service.rs # Сервис подписок
│   │   │   ├── system_service.rs    # Системный сервис
│   │   │   └── update_service.rs    # Сервис обновлений
│   │   ├── entity/    # Сущности данных
│   │   ├── process/   # Управление процессами
│   │   ├── utils/     # Вспомогательные функции
│   │   ├── config.rs  # Управление конфигурацией
│   │   ├── lib.rs     # Входная точка библиотеки
│   │   └── main.rs    # Входная точка программы
│   └── Cargo.toml     # Конфигурация зависимостей Rust
└── package.json       # Конфигурация проекта
```

## Настройка среды разработки

### Системные требования

- Windows 10 1809 или выше
- Последняя версия Rust toolchain
- Node.js 18.0+
- pnpm пакетный менеджер
- Visual Studio 2019+ (с инструментами для разработки на C++)
- Git

### Установка среды

1. **Установка Rust**

   ```bash
   # Установка с помощью rustup
   curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
   # Для Windows можно скачать установщик с https://rustup.rs
   ```

2. **Установка Node.js и pnpm**

   ```bash
   # Установка Node.js: https://nodejs.org/
   # Установка pnpm
   npm install -g pnpm
   ```

3. **Установка Visual Studio**
   Убедитесь, что установлена рабочая нагрузка "Разработка классических приложений на C++".

4. **Клонирование проекта**

   ```bash
   git clone https://github.com/xinggaoya/sing-box-windows.git
   cd sing-box-windows
   ```

5. **Установка зависимостей**

   ```bash
   pnpm install
   ```

6. **Запуск сервера разработки**
   ```bash
   pnpm tauri dev
   ```

## Основные функциональные модули

### Управление ядром (kernel_service.rs)

Отвечает за загрузку, запуск, остановку и управление версиями ядра Sing-Box:

- `download_latest_kernel`: загрузка последней версии ядра
- `start_kernel`: запуск сервиса ядра
- `stop_kernel`: остановка сервиса ядра
- `restart_kernel`: перезапуск сервиса ядра
- `check_kernel_version`: проверка версии ядра

### Сервис прокси (proxy_service.rs)

Управление настройками прокси и выбором узлов:

- `set_system_proxy`: установка системного прокси
- `set_tun_proxy`: установка прокси в режиме TUN
- `toggle_proxy_mode`: переключение режима прокси
- `get_proxies`: получение списка узлов прокси
- `change_proxy`: переключение используемого узла прокси
- `test_node_delay`: тестирование задержки узла

### Сервис подписок (subscription_service.rs)

Обработка добавления, обновления и управления подписками прокси:

- `download_subscription`: загрузка содержимого подписки
- `add_manual_subscription`: ручное добавление подписки
- `get_current_config`: получение текущей конфигурации

### Системный сервис (system_service.rs)

Обработка функций, связанных с операционной системой:

- `check_admin`: проверка прав администратора
- `restart_as_admin`: перезапуск с правами администратора
- `get_traffic_data`: получение данных о трафике

### Сервис обновлений (update_service.rs)

Обработка обновлений приложения:

- `check_update`: проверка обновлений
- `download_and_install_update`: загрузка и установка обновлений

## Руководство по разработке фронтенда

### Управление состоянием

Проект использует Pinia для управления состоянием, основные хранилища включают:

1. **appStore**: глобальное состояние приложения

   - Управление состоянием приложения
   - Управление состоянием окна
   - Обработка конфигурации приложения

2. **infoStore**: состояние информации о ядре

   - Управление информацией о версии ядра
   - Обработка состояния ядра и прослушивание событий

3. **trayStore**: состояние системного трея
   - Управление иконкой и меню системного трея

### Стандарты разработки компонентов

1. **Именование компонентов**:

   - Компоненты страниц используют формат `XxxView.vue`
   - Общие компоненты используют формат `XxxComponent.vue`
   - Компоненты макета используют формат `XxxLayout.vue`

2. **Стандарты стилей**:

   - Использование scoped CSS
   - Следование BEM методологии именования
   - Использование переменных для управления цветами и размерами

3. **Обработка событий**:
   - Использование шины событий mitt для межкомпонентного взаимодействия
   - Внутренние события компонентов обрабатываются через опцию emits

### Управление маршрутизацией

Все маршруты определены в `src/router/index.ts`, добавление новых страниц требует добавления маршрутов в этом файле.

## Руководство по разработке бэкенда

### Регистрация команд

Все команды, доступные для вызова с фронтенда, регистрируются в функции `run()` в `src-tauri/src/lib.rs` через `invoke_handler`:

```rust
.invoke_handler(tauri::generate_handler![
    start_kernel,
    download_latest_kernel,
    // другие команды...
])
```

### Процесс разработки новых функций

1. Определите функцию в соответствующем сервисном модуле
2. Импортируйте и зарегистрируйте эту функцию в `lib.rs`
3. Вызовите эту функцию с фронтенда через `invoke`

Пример:

```rust
// В kernel_service.rs
#[tauri::command]
pub async fn my_new_function(param: String) -> Result<String, String> {
    // Реализация логики
    Ok("Успешно".to_string())
}

// Регистрация в lib.rs
.invoke_handler(tauri::generate_handler![
    // другие команды...
    my_new_function,
])
```

```typescript
// Вызов с фронтенда
import { invoke } from '@tauri-apps/api/tauri'

async function callMyFunction() {
  try {
    const result = await invoke('my_new_function', { param: 'test' })
    console.log(result)
  } catch (error) {
    console.error(error)
  }
}
```

### Управление процессами

Управление процессами ядра находится в модуле `process`, при изменении кода необходимо учитывать:

- Убедитесь, что процессы правильно запускаются и останавливаются
- Обрабатывайте вопросы прав доступа
- Управляйте жизненным циклом процессов

## Сборка и выпуск

### Сборка для разработки

```bash
pnpm tauri dev
```

### Сборка для продакшена

```bash
pnpm tauri build
```

Эта команда создаст установочный пакет в директории `src-tauri/target/release/bundle`.

### Процесс выпуска

1. Обновите номер версии (в `package.json` и `src-tauri/tauri.conf.json`)
2. Выполните сборку
3. Протестируйте установочный пакет
4. Создайте релиз на GitHub
5. Загрузите установочный пакет

## Часто задаваемые вопросы

### В: Как отлаживать код бэкенда на Rust?

О: Можно использовать расширение Rust Analyzer для Visual Studio Code, а также `console.log` и функции логирования Tauri.
Добавление функции `devtools` в секцию `[features]` в `Cargo.toml` также позволяет включить инструменты разработчика.

### В: Как осуществляется связь между фронтендом и бэкендом?

О: Используется API `invoke` Tauri для связи, бэкенд принимает запросы через функции, помеченные `#[tauri::command]`.

### В: Как обрабатывать вопросы прав доступа?

О: Используйте функции `check_admin` и `restart_as_admin` в `system_service.rs` для проверки и запроса прав администратора.
Режим TUN должен работать с правами администратора.

### В: Как добавлять новые зависимости?

О: Фронтенд зависимости добавляются через `pnpm add`, бэкенд зависимости добавляются в `Cargo.toml`.

---

## Руководство по вкладу

Мы приветствуем любые формы вклада, включая, но не ограничиваясь:

- Вклад в код
- Улучшение документации
- Сообщения об ошибках
- Предложения по функциям

Пожалуйста, ознакомьтесь с процессом вклада в README.md в корневой директории проекта.
